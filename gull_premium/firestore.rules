rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper functions ─────────────────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated()
          && (
            (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
          || exists(/databases/$(database)/documents/admins/$(request.auth.uid)));
    }

    function isVendor() {
      return isAuthenticated()
          && exists(/databases/$(database)/documents/users/$(request.auth.uid))
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'vendor';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ─── users ─────────────────────────────────────────────────────────────
    // User: read/write own document only. Admin: read/write all.
    match /users/{userId} {
      allow read, write: if isAdmin() || isOwner(userId);
    }

    // ─── products ──────────────────────────────────────────────────────────
    // Read (Public): only when status == 'approved'.
    // Read (Vendor): own products (any status) so they can see pending items.
    // Read/Write (Admin): full access.
    // Create: admin or vendor. Update/Delete: admin, or vendor (own product only).
    match /products/{productId} {
      allow read: if resource.data.status == 'approved'
          || (isVendor() && resource.data.vendorId == request.auth.uid)
          || isAdmin();
      allow create: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'vendor'];
      allow update, delete: if isAdmin()
          || (request.auth != null
              && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'vendor'
              && resource.data.vendorId == request.auth.uid);
    }

    // ─── counters (e.g. bouquet code sequence) ──────────────────────────────
    // Vendors need to reserve next bouquet code when publishing; admins too.
    // Read: authenticated. Write: admin or vendor only (prevents customers from manipulating codes).
    match /counters/{counterId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isVendor();
    }

    // ─── bouquets (flower products) ────────────────────────────────────────
    // Read: public. Create: admin (any) or vendor (only with approvalStatus == 'pending').
    // Fallback create by owner (vendorId == uid) so publish works on mobile when isVendor() get() fails.
    // Update: admins; or analytics-only (viewCount/orderCount); or vendor own (priceIqd, imageUrls, thumbnailUrls).
    // Delete: admins; or vendor for their own bouquets (owner fallback for mobile).
    match /bouquets/{bouquetId} {
      allow read: if true;
      allow create: if isAdmin()
          || (isVendor() && request.resource.data.approvalStatus == 'pending')
          || (request.auth != null
              && request.resource.data.approvalStatus == 'pending'
              && request.resource.data.vendorId == request.auth.uid);
      allow delete: if isAdmin()
          || (isVendor() && resource.data.vendorId == request.auth.uid)
          || (request.auth != null && resource.data.vendorId == request.auth.uid);
      allow update: if isAdmin()
          || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount'])
          || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['orderCount'])
          || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount', 'orderCount'])
          || (resource.data.vendorId == request.auth.uid
              && (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['priceIqd'])
                  || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['imageUrls'])
                  || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['imageUrls', 'thumbnailUrls'])))
          // Vendor resubmit: change rejected -> pending (clears rejectionReason, rejectionNote)
          || (resource.data.vendorId == request.auth.uid
              && resource.data.approvalStatus == 'rejected'
              && request.resource.data.approvalStatus == 'pending'
              && (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['approvalStatus'])
                  || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['approvalStatus', 'rejectionReason', 'rejectionNote'])));
    }

    // ─── orders ────────────────────────────────────────────────────────────
    // Create: any authenticated user. Must include denormalized user snapshot
    // (userName, userPhone, userAddress) for admin list views (fewer reads).
    // Read: owner or admin. Admin reads all for order list (no user join needed).
    // Update: admins only (e.g. status). Users cannot update after create.
    match /orders/{orderId} {
      allow create: if isAuthenticated()
          && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated()
          && (resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ─── vendors ───────────────────────────────────────────────────────────
    // Read: public. Write: admins only.
    match /vendors/{vendorId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // ─── admins ───────────────────────────────────────────────────────────
    // Used to grant admin access. Read: authenticated (to check isAdmin). Write: console only.
    match /admins/{adminId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ─── vendor_applications ──────────────────────────────────────────────
    // Create: new vendor applicant (doc id = their uid). Read/update: admin only (list pending, approve/reject).
    match /vendor_applications/{applicationId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated() && applicationId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ─── addons (vases, chocolates, cards) ─────────────────────────────────
    // Read: public (customers see add-ons at checkout).
    // Write: admin only (Super Admin manages add-on inventory).
    match /addons/{addonId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Default: deny all other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
