rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper functions ─────────────────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated()
          && exists(/databases/$(database)/documents/users/$(request.auth.uid))
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ─── users ─────────────────────────────────────────────────────────────
    // User: read/write own document only. Admin: read/write all.
    match /users/{userId} {
      allow read, write: if isAdmin() || isOwner(userId);
    }

    // ─── products ──────────────────────────────────────────────────────────
    // Read: public. Write/Update/Delete: admins only.
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // ─── bouquets (flower products) ────────────────────────────────────────
    // Read: public. Create/Delete: admins only.
    // Update: admins; or public for analytics-only (viewCount/orderCount increments).
    match /bouquets/{bouquetId} {
      allow read: if true;
      allow create, delete: if isAdmin();
      allow update: if isAdmin()
          || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount'])
          || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['orderCount'])
          || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount', 'orderCount']);
    }

    // ─── orders ────────────────────────────────────────────────────────────
    // Create: any authenticated user. Must include denormalized user snapshot
    // (userName, userPhone, userAddress) for admin list views (fewer reads).
    // Read: owner or admin. Admin reads all for order list (no user join needed).
    // Update: admins only (e.g. status). Users cannot update after create.
    match /orders/{orderId} {
      allow create: if isAuthenticated()
          && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated()
          && (resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ─── vendors ───────────────────────────────────────────────────────────
    // Read: public. Write: admins only.
    match /vendors/{vendorId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Default: deny all other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
