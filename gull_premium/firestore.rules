rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper functions ─────────────────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated()
          && exists(/databases/$(database)/documents/users/$(request.auth.uid))
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isVendor() {
      return isAuthenticated()
          && exists(/databases/$(database)/documents/users/$(request.auth.uid))
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'vendor';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ─── users ─────────────────────────────────────────────────────────────
    // User: read/write own document only. Admin: read/write all.
    match /users/{userId} {
      allow read, write: if isAdmin() || isOwner(userId);
    }

    // ─── products ──────────────────────────────────────────────────────────
    // Read (Public): only when status == 'approved'.
    // Read (Vendor): own products (any status) so they can see pending items.
    // Read/Write (Admin): full access.
    // Create: admin or vendor. Update/Delete: admin, or vendor (own product only).
    match /products/{productId} {
      allow read: if resource.data.status == 'approved'
          || (isVendor() && resource.data.vendorId == request.auth.uid)
          || isAdmin();
      allow create: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'vendor'];
      allow update, delete: if isAdmin()
          || (request.auth != null
              && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'vendor'
              && resource.data.vendorId == request.auth.uid);
    }

    // ─── counters (e.g. bouquet code sequence) ──────────────────────────────
    // Vendors need to reserve next bouquet code when publishing; admins too.
    match /counters/{counterId} {
      allow read, write: if isAuthenticated();
    }

    // ─── bouquets (flower products) ────────────────────────────────────────
    // Read: public. Create: admin (any) or vendor (only with approvalStatus == 'pending').
    // Update: admins (e.g. set approvalStatus to approved/rejected); or analytics-only (viewCount/orderCount).
    // Delete: admins only. Approved bouquets appear on main screen.
    match /bouquets/{bouquetId} {
      allow read: if true;
      allow create: if isAdmin()
          || (isVendor() && request.resource.data.approvalStatus == 'pending');
      allow delete: if isAdmin();
      allow update: if isAdmin()
          || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount'])
          || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['orderCount'])
          || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount', 'orderCount']);
    }

    // ─── orders ────────────────────────────────────────────────────────────
    // Create: any authenticated user. Must include denormalized user snapshot
    // (userName, userPhone, userAddress) for admin list views (fewer reads).
    // Read: owner or admin. Admin reads all for order list (no user join needed).
    // Update: admins only (e.g. status). Users cannot update after create.
    match /orders/{orderId} {
      allow create: if isAuthenticated()
          && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated()
          && (resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ─── vendors ───────────────────────────────────────────────────────────
    // Read: public. Write: admins only.
    match /vendors/{vendorId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Default: deny all other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
